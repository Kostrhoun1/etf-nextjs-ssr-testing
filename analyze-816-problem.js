const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  'https://nbhwnatadyubiuadfakx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaHduYXRhZHl1Yml1YWRmYWt4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODg0NDc0NCwiZXhwIjoyMDY0NDIwNzQ0fQ.SI_s72FBMs2qSqhKBsm7ZJSnPOnCEfWn1zQ6nxMtgyo'
);

// The 81 problematic ISINs from the user's list (first 100)
const problematicISINs = [
  'LU2059756754',
  'IE00BKWD3966',
  'IE000V6BYU61',
  'IE000XIMFW40',
  'LU1865138329',
  'LU1956004583',
  'LU2197908721',
  'IE000N5ZIE63',
  'IE00013CKPA1',
  'LU1955960531',
  'IE000J7MMEW1',
  'IE000OQPB3I9',
  'LU1955960375',
  'IE00BMPRXR70',
  'IE0005WX0V47',
  'IE000RXNZ617',
  'IE000EH5GMA7',
  'IE000BVLFS58',
  'LU1956004237',
  'IE000FBXBZN4',
  'LU2127437825',
  'IE000GL3QEL0',
  'LU2127437585',
  'IE0009WL8PX4',
  'IE000MLKWCY8',
  'LU2127438039',
  'LU2127437312',
  'IE000RXQIM48',
  'IE000YR9WJW2',
  'IE000O8S3KP3',
  'IE000Q4CHIF9',
  'IE000ED8REQ6',
  'LU2023679256',
  'IE000PZ5I5A2',
  'LU2024084136',
  'IE00BKPS5C93',
  'IE0003U5U3R6',
  'IE0003MV9EI7',
  'IE0003YLD1U9',
  'IE000ZTQMYW9',
  'IE000W45ZBC2',
  'IE000TEYV4Q3',
  'IE000VCFBV64',
  'IE000VK09VI1',
  'IE000VK09TY4',
  'IE000ENG55N1',
  'IE000KXLQ9J8',
  'IE000KXLQ7F6',
  'IE000KXLQ8H3',
  'IE000T9YFBU5',
  'IE000M6IU6B7',
  'LU2025912409',
  'IE000F7KAL72',
  'IE000R5BPUV2',
  'IE0002OKPX78',
  'LU2206230972',
  'IE000BT3F2K5',
  'IE000N9WV9N7',
  'LU1931975020',
  'LU2245039266',
  'IE000WQH1DV3',
  'IE000CVMK7R1',
  'IE00013CK3C0',
  'IE000NHBXWZ4',
  'LU2197910073',
  'LU0937837892',
  'LU1437023168',
  'LU1437024067',
  'LU2250812780',
  'IE000C75W2Y4',
  'LU2097735509',
  'LU2456439462',
  'IE000QMOXNI9',
  'LU2023678704',
  'IE000RVWNMY1',
  'IE000TW0PW70',
  'IE000VE1ZDG3',
  'LU2037749806',
  'IE000B2G0S62',
  'IE000S9G45H6',
  'IE000FRNV4R7',
];

(async () => {
  console.log(`Analyzing ${problematicISINs.length} problematic ISIN pages...\n`);

  const { data, error } = await supabase
    .from('etf_funds')
    .select('isin, primary_ticker, name, fund_size_numeric, ter_numeric, rating')
    .in('isin', problematicISINs);

  if (error) {
    console.error('Error:', error);
    return;
  }

  console.log(`Found ${data.length} out of ${problematicISINs.length} ISINs in database\n`);

  // Analyze common characteristics
  const withTicker = data.filter(e => e.primary_ticker && e.primary_ticker !== '-' && e.primary_ticker.length >= 2);
  const withoutTicker = data.filter(e => !e.primary_ticker || e.primary_ticker === '-' || e.primary_ticker.length < 2);
  const withSize = data.filter(e => e.fund_size_numeric !== null && e.fund_size_numeric > 0);
  const withoutSize = data.filter(e => !e.fund_size_numeric || e.fund_size_numeric === 0);

  // Size distribution
  const sizes = withSize.map(e => e.fund_size_numeric).sort((a, b) => b - a);

  console.log('=== CHARACTERISTICS ===');
  console.log(`With valid ticker: ${withTicker.length} (${(withTicker.length/data.length*100).toFixed(0)}%)`);
  console.log(`Without valid ticker: ${withoutTicker.length} (${(withoutTicker.length/data.length*100).toFixed(0)}%)`);
  console.log(`With fund size: ${withSize.length}`);
  console.log(`Without fund size: ${withoutSize.length}`);

  if (sizes.length > 0) {
    console.log(`\nSize range: ${sizes[0]}M EUR (max) to ${sizes[sizes.length-1]}M EUR (min)`);
    console.log(`Median size: ${sizes[Math.floor(sizes.length/2)]}M EUR`);
  }

  // Sample 5 with tickers
  console.log('\n=== SAMPLE 5 WITH TICKERS ===');
  withTicker.slice(0, 5).forEach(e => {
    console.log(`${e.isin} -> Ticker: ${e.primary_ticker}, Size: ${e.fund_size_numeric || 0}M, Rating: ${e.rating || 'N/A'}`);
    console.log(`  /etf/${e.isin} (ISIN page exists)`);
    console.log(`  Ticker page would be: /etf/ticker/${e.primary_ticker} (but NOT in TOP 200 sitemap!)`);
  });

  // Sample 5 without tickers
  console.log('\n=== SAMPLE 5 WITHOUT TICKERS ===');
  withoutTicker.slice(0, 5).forEach(e => {
    console.log(`${e.isin} -> Ticker: ${e.primary_ticker || '(none)'}, Size: ${e.fund_size_numeric || 0}M, Rating: ${e.rating || 'N/A'}`);
    console.log(`  Only ISIN page: /etf/${e.isin}`);
  });

  console.log('\n\n=== HYPOTHESIS ===');
  console.log('The problematic 81 ISIN pages are small/unpopular ETFs that:');
  console.log('1. Are NOT in TOP 200 sitemap (no ticker pages)');
  console.log('2. Have ISIN pages generated by Next.js SSR');
  console.log('3. Google crawled them on Sept 27, 2025');
  console.log('4. But Google marks them as "alternative page with correct canonical"');
  console.log('');
  console.log('POSSIBLE CAUSES:');
  console.log('A) These pages have thin content / low quality');
  console.log('B) Google found them in internal links but doesn\'t want to index them');
  console.log('C) They have correct canonical but Google prefers another version');
  console.log('D) There\'s a technical SEO issue we haven\'t discovered yet');
})();
